<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FinNews">
<meta name="theme-color" content="#060910">
<meta name="description" content="é‡‘èãƒ‹ãƒ¥ãƒ¼ã‚¹é›†ç´„ã‚¢ãƒ—ãƒª - ã‚µãƒ¼ãƒãƒ¼ä¸è¦">
<link rel="apple-touch-icon" href="icon.png">
<title>FinNews</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,400;0,500;1,400&family=Syne:wght@700;800&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #060910;
  --bg1: #0b0f1a;
  --bg2: #0f1521;
  --surface: #121a2b;
  --surface2: #172135;
  --border: #1c2a40;
  --border2: #223248;
  --accent: #3d8ef0;
  --accent2: #5ba3f5;
  --glow: rgba(61,142,240,0.18);
  --green: #2ecc8a;
  --green2: #40e09a;
  --red: #f0556a;
  --yellow: #f5c842;
  --text: #d0e0f0;
  --text2: #6888a8;
  --text3: #2d4460;
  --safe-t: env(safe-area-inset-top);
  --safe-b: env(safe-area-inset-bottom);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);
  font-family:'Noto Sans JP',sans-serif;font-weight:300;-webkit-font-smoothing:antialiased}

/* â”€â”€ App shell â”€â”€ */
.app{display:flex;flex-direction:column;height:100%;height:100dvh;position:relative}

/* â”€â”€ Header â”€â”€ */
.hdr{
  flex-shrink:0;
  padding:calc(var(--safe-t) + 12px) 18px 12px;
  background:rgba(6,9,16,0.9);
  backdrop-filter:blur(24px) saturate(200%);
  -webkit-backdrop-filter:blur(24px) saturate(200%);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;
}
.logo{
  font-family:'Syne',sans-serif;font-size:20px;font-weight:800;
  letter-spacing:-0.5px;color:#fff;
}
.logo em{color:var(--accent);font-style:normal}
.hdr-tag{
  font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;
  color:var(--text3);text-transform:uppercase;margin-top:2px;
}
.signal{
  margin-left:auto;display:flex;align-items:center;gap:6px;
  font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);
}
.signal-dot{width:6px;height:6px;border-radius:50%;background:var(--text3)}
.signal-dot.live{background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* â”€â”€ Search â”€â”€ */
.search-wrap{flex-shrink:0;padding:14px 16px 8px;background:var(--bg)}
.search-box{
  display:flex;align-items:center;gap:0;
  background:var(--surface);border:1.5px solid var(--border2);
  border-radius:16px;overflow:hidden;transition:border-color .2s,box-shadow .2s;
}
.search-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
.search-icon{padding:0 12px;font-size:16px;flex-shrink:0}
.ticker-in{
  flex:1;background:transparent;border:none;outline:none;
  color:#fff;font-family:'DM Mono',monospace;font-size:18px;font-weight:500;
  letter-spacing:2px;text-transform:uppercase;padding:12px 0;
  caret-color:var(--accent);
}
.ticker-in::placeholder{color:var(--text3);font-size:14px;letter-spacing:.5px;font-family:'Noto Sans JP',sans-serif}
.go-btn{
  background:var(--accent);color:#fff;border:none;
  padding:0 20px;height:100%;min-height:50px;
  font-family:'Syne',sans-serif;font-size:14px;font-weight:700;
  cursor:pointer;transition:background .15s;white-space:nowrap;
  -webkit-appearance:none;
}
.go-btn:active{background:#2a7ee8}
.go-btn.busy{background:var(--surface2);color:var(--text2)}

/* â”€â”€ Quick chips â”€â”€ */
.chips{
  flex-shrink:0;padding:0 16px 10px;display:flex;gap:7px;
  overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;
}
.chips::-webkit-scrollbar{display:none}
.chip{
  flex-shrink:0;background:var(--surface);border:1px solid var(--border2);
  border-radius:8px;padding:5px 11px;font-family:'DM Mono',monospace;
  font-size:11px;color:var(--text2);cursor:pointer;transition:all .15s;
}
.chip:active,.chip.on{
  background:rgba(61,142,240,.12);color:var(--accent2);
  border-color:rgba(61,142,240,.4);
}

/* â”€â”€ Progress â”€â”€ */
.prog-rail{flex-shrink:0;height:2px;background:var(--border);overflow:hidden}
.prog-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0;transition:width .3s}
.prog-bar.spin{width:45%;animation:sweep 1.5s ease-in-out infinite}
@keyframes sweep{0%{transform:translateX(-200%)}100%{transform:translateX(320%)}}
.status{
  flex-shrink:0;padding:5px 16px 3px;
  font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);
  min-height:20px;letter-spacing:.3px;
}

/* â”€â”€ Stats â”€â”€ */
.stats{
  flex-shrink:0;display:none;
  border-top:1px solid var(--border);border-bottom:1px solid var(--border);
}
.stats.show{display:flex}
.stat{flex:1;background:var(--bg1);padding:9px 0;text-align:center;cursor:pointer;transition:background .15s}
.stat+.stat{border-left:1px solid var(--border)}
.stat:active{background:var(--surface)}
.snum{font-family:'DM Mono',monospace;font-size:19px;font-weight:500;line-height:1}
.slbl{font-size:9px;margin-top:2px;letter-spacing:.8px;text-transform:uppercase}
.c-all{color:var(--accent2)} .c-pos{color:var(--green2)} .c-neg{color:var(--red)} .c-neu{color:var(--text3)}
.l-all{color:var(--text3)} .l-pos{color:var(--green)} .l-neg{color:var(--red)} .l-neu{color:var(--text3)}

/* â”€â”€ Filter tabs â”€â”€ */
.ftabs{
  flex-shrink:0;display:none;padding:8px 16px 6px;
  gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;
}
.ftabs.show{display:flex}
.ftabs::-webkit-scrollbar{display:none}
.ftab{
  flex-shrink:0;padding:5px 13px;border-radius:20px;
  border:1px solid var(--border);background:transparent;
  color:var(--text3);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;
  font-family:'Noto Sans JP',sans-serif;
}
.ftab.ta{border-color:var(--accent);color:var(--accent2);background:rgba(61,142,240,.1)}
.ftab.tp{border-color:var(--green);color:var(--green2);background:rgba(46,204,138,.08)}
.ftab.tn{border-color:var(--red);color:var(--red);background:rgba(240,85,106,.08)}
.ftab.tu{border-color:var(--border2);color:var(--text2);background:rgba(255,255,255,.03)}
.ftab.ts{border-color:var(--border2);color:var(--text2);background:rgba(255,255,255,.03)}

/* â”€â”€ Article list â”€â”€ */
.list{
  flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;background:var(--bg1);
}
.list::-webkit-scrollbar{display:none}

.card{
  display:flex;gap:11px;padding:13px 16px;
  background:var(--bg);border-bottom:1px solid var(--border);
  text-decoration:none;color:inherit;
  animation:fadeUp .22s ease both;
}
.card:active{background:var(--surface)}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

.bar{width:3px;min-width:3px;border-radius:2px;align-self:stretch;min-height:36px;flex-shrink:0}
.bp{background:var(--green)} .bn{background:var(--red)} .bu{background:var(--border2)}

.card-body{flex:1;min-width:0}
.card-title{
  font-size:13.5px;font-weight:400;line-height:1.5;color:var(--text);margin-bottom:6px;
  display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.card-meta{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.src{
  font-family:'DM Mono',monospace;font-size:9px;padding:2px 7px;
  border-radius:4px;background:var(--surface);color:var(--text2);
  border:1px solid var(--border2);text-transform:uppercase;letter-spacing:.3px;
}
.src-bloomberg{color:#7eb3ff;border-color:rgba(126,179,255,.25);background:rgba(126,179,255,.05)}
.src-wsj      {color:#f5c842;border-color:rgba(245,200,66,.25);background:rgba(245,200,66,.05)}
.src-nikkei   {color:#ffa07a;border-color:rgba(255,160,122,.25);background:rgba(255,160,122,.05)}
.src-reuters  {color:#ef9c6a;border-color:rgba(239,156,106,.25);background:rgba(239,156,106,.05)}
.src-reddit   {color:#ff6b4a;border-color:rgba(255,107,74,.25);background:rgba(255,107,74,.05)}
.src-stocktwits{color:var(--green2);border-color:rgba(46,204,138,.25);background:rgba(46,204,138,.05)}
.src-yahoo    {color:#a78bfa;border-color:rgba(167,139,250,.25);background:rgba(167,139,250,.05)}

.card-date{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace}
.card-score{font-family:'DM Mono',monospace;font-size:10px;font-weight:500;margin-left:auto}
.sp{color:var(--green2)} .sn{color:var(--red)}
.chevron{color:var(--text3);font-size:16px;flex-shrink:0;align-self:center}

/* â”€â”€ Splash â”€â”€ */
.splash{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;gap:14px;padding:40px 28px;text-align:center;
}
.splash-ico{font-size:56px;opacity:.35}
.splash-ttl{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--text2)}
.splash-sub{font-size:13px;color:var(--text3);line-height:1.7;max-width:260px}

/* â”€â”€ Bottom nav â”€â”€ */
.bnav{
  flex-shrink:0;
  background:rgba(6,9,16,.97);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--border);
  display:flex;padding-bottom:var(--safe-b);
}
.ni{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:9px 0 7px;cursor:pointer;color:var(--text3);font-size:10px;font-weight:500;
  transition:color .15s;font-family:'Noto Sans JP',sans-serif;
}
.ni.on{color:var(--accent2)}
.ni-ico{font-size:22px;line-height:1}

/* â”€â”€ Panels â”€â”€ */
.panel{
  position:fixed;inset:0;background:var(--bg);z-index:200;
  display:flex;flex-direction:column;
  transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);
}
.panel.open{transform:translateX(0)}
.phdr{
  padding:calc(var(--safe-t) + 16px) 20px 14px;
  background:var(--bg);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;flex-shrink:0;
}
.pttl{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;flex:1}
.pclose{font-size:22px;cursor:pointer;color:var(--text2);padding:4px;line-height:1}
.pbody{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:20px}

/* Watchlist items */
.witem{
  padding:15px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;cursor:pointer;
}
.witem:active{background:var(--surface)}
.wtick{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--accent2);flex:1}
.wdel{color:var(--text3);padding:4px 8px;font-size:18px}

/* Settings form */
.sfield{margin-bottom:20px}
.sfield label{display:block;font-size:12px;font-weight:500;color:var(--text2);margin-bottom:8px}
.sinput{
  width:100%;background:var(--surface);border:1.5px solid var(--border2);
  border-radius:10px;padding:12px 14px;color:var(--text);
  font-family:'DM Mono',monospace;font-size:13px;outline:none;
  transition:border-color .2s;-webkit-appearance:none;
}
.sinput:focus{border-color:var(--accent)}
.sbtn{
  width:100%;background:var(--accent);color:#fff;border:none;border-radius:12px;
  padding:14px;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;
  cursor:pointer;-webkit-appearance:none;transition:background .15s;
}
.sbtn:active{background:#2a7ee8}
.sinfo{font-size:11px;color:var(--text3);line-height:1.8;margin-top:6px}
.stitle{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;margin-top:20px}

/* â”€â”€ iOS install hint â”€â”€ */
.install{
  display:none;flex-shrink:0;
  background:var(--surface);border-top:1px solid var(--border);
  padding:10px 16px calc(10px + var(--safe-b));
  align-items:center;gap:10px;
}
.install.show{display:flex}
.install-txt{flex:1;font-size:11px;color:var(--text2);line-height:1.5}
.install-x{color:var(--text3);padding:6px;cursor:pointer;font-size:16px;flex-shrink:0}

/* â”€â”€ Lang toggle â”€â”€ */
.lang-toggle{
  display:none;flex-shrink:0;padding:6px 16px 4px;
  gap:4px;align-items:center;background:var(--bg);
}
.lang-toggle.show{display:flex}
.lang-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;margin-right:6px}
.lang-btn{
  font-family:'DM Mono',monospace;font-size:11px;font-weight:500;
  border:1px solid var(--border2);background:transparent;color:var(--text2);
  border-radius:6px;padding:4px 10px;cursor:pointer;transition:all .15s;
  -webkit-appearance:none;
}
.lang-btn.active{
  background:rgba(61,142,240,.15);color:var(--accent2);
  border-color:rgba(61,142,240,.5);
}
.lang-btn:active{opacity:.7}
.translating-badge{
  margin-left:auto;font-family:'DM Mono',monospace;font-size:9px;
  color:var(--yellow);letter-spacing:.5px;opacity:0;transition:opacity .3s;
}
.translating-badge.show{opacity:1}

/* â”€â”€ Error toast â”€â”€ */
.toast{
  position:fixed;bottom:calc(80px + var(--safe-b));left:50%;transform:translateX(-50%) translateY(20px);
  background:#1a1a2e;border:1px solid var(--red);color:var(--red);
  padding:10px 18px;border-radius:10px;font-size:12px;font-family:'DM Mono',monospace;
  opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;z-index:999;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="hdr">
    <div>
      <div class="logo">Fin<em>News</em></div>
      <div class="hdr-tag">Financial Intelligence</div>
    </div>
    <div class="signal">
      <div class="signal-dot" id="sigDot"></div>
      <span id="sigTxt">å¾…æ©Ÿä¸­</span>
    </div>
  </div>

  <!-- Search -->
  <div class="search-wrap">
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input class="ticker-in" id="tickerIn" type="text"
        placeholder="ä¾‹: AAPL / 7203.T"
        autocomplete="off" autocorrect="off"
        autocapitalize="characters" spellcheck="false">
      <button class="go-btn" id="goBtn" onclick="doFetch()">å–å¾—</button>
    </div>
  </div>

  <!-- Quick chips -->
  <div class="chips">
    <div class="chip" onclick="setTick('AAPL')">AAPL</div>
    <div class="chip" onclick="setTick('TSLA')">TSLA</div>
    <div class="chip" onclick="setTick('NVDA')">NVDA</div>
    <div class="chip" onclick="setTick('MSFT')">MSFT</div>
    <div class="chip" onclick="setTick('AMZN')">AMZN</div>
    <div class="chip" onclick="setTick('META')">META</div>
    <div class="chip" onclick="setTick('7203.T')">7203.T</div>
    <div class="chip" onclick="setTick('9984.T')">9984.T</div>
    <div class="chip" onclick="setTick('6758.T')">6758.T</div>
  </div>

  <!-- Progress + status -->
  <div class="prog-rail"><div class="prog-bar" id="prog"></div></div>
  <div class="status" id="status"></div>

  <!-- Stats strip -->
  <div class="stats" id="stats">
    <div class="stat" onclick="flt('all')">
      <div class="snum c-all" id="sAll">0</div>
      <div class="slbl l-all">åˆè¨ˆ</div>
    </div>
    <div class="stat" onclick="flt('positive')">
      <div class="snum c-pos" id="sPos">0</div>
      <div class="slbl l-pos">ãƒã‚¸</div>
    </div>
    <div class="stat" onclick="flt('negative')">
      <div class="snum c-neg" id="sNeg">0</div>
      <div class="slbl l-neg">ãƒã‚¬</div>
    </div>
    <div class="stat" onclick="flt('neutral')">
      <div class="snum c-neu" id="sNeu">0</div>
      <div class="slbl l-neu">ä¸­ç«‹</div>
    </div>
  </div>

  <!-- Filter tabs -->
  <div class="ftabs" id="ftabs">
    <button class="ftab ta" onclick="flt('all')">ã™ã¹ã¦</button>
    <button class="ftab" onclick="flt('positive')">ğŸŸ¢ ãƒã‚¸</button>
    <button class="ftab" onclick="flt('negative')">ğŸ”´ ãƒã‚¬</button>
    <button class="ftab" onclick="flt('neutral')">âšª ä¸­ç«‹</button>
    <button class="ftab" onclick="flt('src:yahoo')">Yahoo</button>
    <button class="ftab" onclick="flt('src:google_news')">Google</button>
    <button class="ftab" onclick="flt('src:reddit')">Reddit</button>
    <button class="ftab" onclick="flt('src:stocktwits')">StockTwits</button>
  </div>

  <!-- Lang toggle -->
  <div class="lang-toggle" id="langToggle">
    <span class="lang-lbl">LANG</span>
    <button class="lang-btn active" id="btnEN" onclick="setLang('en')">EN</button>
    <button class="lang-btn" id="btnJP" onclick="setLang('jp')">JP</button>
    <span class="translating-badge" id="transBadge">ç¿»è¨³ä¸­...</span>
  </div>

  <!-- Article list -->
  <div class="list" id="list">
    <div class="splash">
      <div class="splash-ico">ğŸ“¡</div>
      <div class="splash-ttl">FinNews</div>
      <div class="splash-sub">ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚’å…¥åŠ›ã—ã¦<br>ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—ã—ã¦ãã ã•ã„<br><br>
        <span style="font-size:11px;color:var(--text3)">ã‚µãƒ¼ãƒãƒ¼ä¸è¦ãƒ»4Gå¯¾å¿œ</span>
      </div>
    </div>
  </div>

  <!-- iOS install banner -->
  <div class="install" id="installBanner">
    <span style="font-size:22px">ğŸ“²</span>
    <div class="install-txt">
      Safari â†’ å…±æœ‰ãƒœã‚¿ãƒ³ â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§ã‚¢ãƒ—ãƒªåŒ–ã§ãã¾ã™
    </div>
    <div class="install-x" onclick="dismissInstall()">âœ•</div>
  </div>

  <!-- Bottom nav -->
  <div class="bnav">
    <div class="ni on" id="ni-news" onclick="showTab('news')"><span class="ni-ico">ğŸ“°</span>ãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
    <div class="ni"    id="ni-watch" onclick="showTab('watch')"><span class="ni-ico">ğŸ”–</span>ã‚¦ã‚©ãƒƒãƒ</div>
    <div class="ni"    id="ni-settings" onclick="showTab('settings')"><span class="ni-ico">âš™ï¸</span>è¨­å®š</div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Watchlist Panel -->
<div class="panel" id="watchPanel">
  <div class="phdr">
    <span class="pttl">ğŸ”– ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ</span>
    <span class="pclose" onclick="closePanel()">âœ•</span>
  </div>
  <div id="watchList" style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch"></div>
</div>

<!-- Settings Panel -->
<div class="panel" id="settingsPanel">
  <div class="phdr">
    <span class="pttl">âš™ï¸ è¨­å®š</span>
    <span class="pclose" onclick="closePanel()">âœ•</span>
  </div>
  <div class="pbody">

    <div class="sfield">
      <label>ğŸ“¡ ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚½ãƒ¼ã‚¹ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:4px" id="srcToggles">
        <!-- dynamically rendered -->
      </div>
    </div>

    <div class="sfield" style="margin-top:24px">
      <label>ğŸ“± ãƒªãƒ³ã‚¯ã‚’é–‹ããƒ–ãƒ©ã‚¦ã‚¶ <span style="font-size:10px;color:var(--text3)">(iPhone)</span></label>
      <select class="sinput" id="browserSelect" onchange="saveCfg()">
        <option value="safari">Safariï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</option>
        <option value="chrome">Google Chrome</option>
        <option value="brave">Brave</option>
        <option value="firefox">Firefox</option>
        <option value="edge">Microsoft Edge</option>
      </select>
      <div class="sinfo">é¸æŠã—ãŸãƒ–ãƒ©ã‚¦ã‚¶ãŒiPhoneã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</div>
    </div>

    <div class="sfield" style="margin-top:24px">
      <label>ğŸŒ CORSãƒ—ãƒ­ã‚­ã‚·</label>
      <select class="sinput" id="proxySelect" onchange="saveCfg()">
        <option value="allorigins">allorigins.winï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</option>
        <option value="corsproxy">corsproxy.io</option>
        <option value="direct">ç›´æ¥ï¼ˆCORSåˆ¶é™ã‚ã‚Šï¼‰</option>
      </select>
      <div class="sinfo">ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒå–å¾—ã§ããªã„å ´åˆã«å¤‰æ›´ã—ã¦ãã ã•ã„</div>
    </div>

    <div style="padding-top:20px;border-top:1px solid var(--border);margin-top:16px">
      <div class="stitle">ğŸ“– ä½¿ã„æ–¹</div>
      <div style="font-size:12px;color:var(--text3);line-height:1.9">
        1. ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚’å…¥åŠ›ï¼ˆä¾‹: AAPLã€7203.Tï¼‰<br>
        2.ã€Œå–å¾—ã€ãƒœã‚¿ãƒ³ã§è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‚’ä¸¦åˆ—å–å¾—<br>
        3. æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ã§è‡ªå‹•åˆ†é¡<br>
        4. ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã«ä¿å­˜ã—ã¦æ¬¡å›ã‚‚ç´ æ—©ãã‚¢ã‚¯ã‚»ã‚¹<br>
        <br>
        <span style="color:var(--text2)">âœ… ã‚µãƒ¼ãƒãƒ¼ä¸è¦ â€” 4G/5Gã§å‹•ä½œ<br>
        âœ… ãƒ‡ãƒ¼ã‚¿ã¯iPhoneå†…ã«ä¿å­˜</span>
      </div>
    </div>

    <div style="padding-top:20px;border-top:1px solid var(--border);margin-top:16px">
      <div class="stitle">âš ï¸ ã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦</div>
      <div style="font-size:11px;color:var(--text3);line-height:1.8">
        Bloombergãƒ»WSJãƒ»æ—¥çµŒã¯Google NewsçµŒç”±ã§ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã®ã¿å–å¾—ã—ã¾ã™ï¼ˆæœ¬æ–‡ã¯ãƒªãƒ³ã‚¯å…ˆã§ç¢ºèªï¼‰ã€‚
        StockTwitsã¯APIã‚’ä½¿ç”¨ã€‚Redditã¯å…¬é–‹JSONã‚’ä½¿ç”¨ã€‚
      </div>
    </div>

    <button class="sbtn" style="margin-top:24px" onclick="clearData()">ğŸ—‘ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG & STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SOURCES_DEF = [
  { id:'yahoo',       label:'Yahoo Finance',  icon:'ğŸ“Š', enabled:true  },
  { id:'google_news', label:'Google News',    icon:'ğŸ“°', enabled:true,  note:'Bloomberg/WSJ/æ—¥çµŒå«ã‚€' },
  { id:'stocktwits',  label:'StockTwits',     icon:'ğŸ’¬', enabled:true  },
  { id:'reddit',      label:'Reddit',         icon:'ğŸ—£', enabled:true  },
];

let cfg = JSON.parse(localStorage.getItem('fn_cfg') || 'null') || {
  proxy: 'allorigins',
  browser: 'safari',
  sources: Object.fromEntries(SOURCES_DEF.map(s => [s.id, s.enabled]))
};
if (!cfg.browser) cfg.browser = 'safari'; // migrate old saves
let watchlist = JSON.parse(localStorage.getItem('fn_watch') || '[]');
let articles  = [];
let filter    = 'all';
let curTick   = '';
let langMode  = 'en'; // 'en' or 'jp'
let translationCache = {}; // url -> translated title

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROXY HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function proxyUrl(url) {
  const p = cfg.proxy || 'allorigins';
  if (p === 'allorigins') return `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
  if (p === 'corsproxy')  return `https://corsproxy.io/?${encodeURIComponent(url)}`;
  return url;
}

async function fetchXml(url) {
  const p = cfg.proxy || 'allorigins';
  const resp = await fetch(proxyUrl(url), { signal: AbortSignal.timeout(12000) });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  if (p === 'allorigins') {
    const j = await resp.json();
    return j.contents;
  }
  return await resp.text();
}

async function fetchJson(url) {
  const resp = await fetch(proxyUrl(url), { signal: AbortSignal.timeout(12000) });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const p = cfg.proxy || 'allorigins';
  if (p === 'allorigins') {
    const j = await resp.json();
    return JSON.parse(j.contents);
  }
  return await resp.json();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RSS PARSER (browser-native DOMParser)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseRss(xmlStr) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlStr, 'text/xml');
  const items = Array.from(doc.querySelectorAll('item, entry'));
  return items.map(el => {
    const get = (...tags) => {
      for (const t of tags) {
        const node = el.querySelector(t);
        if (node?.textContent?.trim()) return node.textContent.trim();
      }
      return '';
    };
    const link = get('link') || el.querySelector('link')?.getAttribute('href') || '';
    const pubRaw = get('pubDate','published','updated','dc\\:date');
    return {
      title:   get('title'),
      url:     link,
      summary: get('description','summary','content','content\\:encoded').replace(/<[^>]+>/g,'').slice(0,200),
      pubRaw,
      pubDate: pubRaw ? new Date(pubRaw) : null,
    };
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CRAWLERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ONE_MONTH_AGO = Date.now() - 30 * 86400 * 1000;

function isRecent(d) { return !d || isNaN(d) || d.getTime() > ONE_MONTH_AGO; }

async function crawlYahoo(ticker) {
  const isJP = ticker.endsWith('.T') || /^\d{4}$/.test(ticker);
  let url, lang;
  if (isJP) {
    const code = ticker.replace('.T','');
    url  = `https://finance.yahoo.co.jp/news/rss/${code}`;
    lang = 'ja';
  } else {
    url  = `https://feeds.finance.yahoo.com/rss/2.0/headline?s=${ticker}&region=US&lang=en-US`;
    lang = 'en';
  }
  const xml  = await fetchXml(url);
  const items = parseRss(xml);
  return items
    .filter(i => isRecent(i.pubDate))
    .map(i => ({ ...i, source:'yahoo', lang }));
}

async function crawlGoogleNews(ticker) {
  const isJP = ticker.endsWith('.T') || /^\d{4}$/.test(ticker);
  const hl   = isJP ? 'ja' : 'en-US';
  const gl   = isJP ? 'JP' : 'US';
  const q    = encodeURIComponent(`${ticker} stock`);
  const url  = `https://news.google.com/rss/search?q=${q}&hl=${hl}&gl=${gl}&ceid=${gl}:${isJP?'ja':'en'}`;
  const xml  = await fetchXml(url);
  const items = parseRss(xml);
  return items.filter(i => isRecent(i.pubDate)).map(i => {
    // è¨˜äº‹ã®ã‚½ãƒ¼ã‚¹ã‚’æ¨å®š
    let src = 'google_news';
    const u = (i.url + i.title).toLowerCase();
    if (u.includes('bloomberg')) src = 'bloomberg';
    else if (u.includes('wsj.com') || u.includes('wall street journal')) src = 'wsj';
    else if (u.includes('nikkei')) src = 'nikkei';
    else if (u.includes('reuters')) src = 'reuters';
    return { ...i, source: src, lang: isJP ? 'ja' : 'en' };
  });
}

async function crawlStockTwits(ticker) {
  if (ticker.endsWith('.T') || /^\d{4}$/.test(ticker)) return [];
  const data = await fetchJson(`https://api.stocktwits.com/api/2/streams/symbol/${ticker}.json?limit=30`);
  const msgs = data.messages || [];
  return msgs
    .filter(m => isRecent(new Date(m.created_at)))
    .map(m => ({
      title:   m.body.slice(0,140),
      url:     `https://stocktwits.com/message/${m.id}`,
      summary: m.body,
      pubDate: new Date(m.created_at),
      source:  'stocktwits',
      lang:    'en',
    }));
}

async function crawlReddit(ticker) {
  const isJP = ticker.endsWith('.T') || /^\d{4}$/.test(ticker);
  const subs  = isJP ? ['japanfinance'] : ['investing','stocks','wallstreetbets','StockMarket'];
  const out   = [];
  for (const sub of subs) {
    try {
      const url  = `https://www.reddit.com/r/${sub}/search.json?q=${encodeURIComponent(ticker)}&sort=new&t=month&limit=10&restrict_sr=1`;
      const data = await fetchJson(url);
      const posts = data?.data?.children || [];
      posts.forEach(p => {
        const d = p.data;
        const pubDate = new Date(d.created_utc * 1000);
        if (!isRecent(pubDate)) return;
        out.push({
          title:   d.title,
          url:     `https://www.reddit.com${d.permalink}`,
          summary: (d.selftext||'').slice(0,200),
          pubDate,
          source:  'reddit',
          lang:    'en',
        });
      });
    } catch(e) { /* skip failed sub */ }
    await sleep(300);
  }
  return out;
}

const sleep = ms => new Promise(r => setTimeout(r, ms));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NLP SENTIMENT (browser-side)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const POS_EN = new Set(['surge','soar','rally','beat','exceed','strong','profit','growth','upgrade',
  'bullish','record','gain','rise','recover','outperform','boost','buy','upbeat','positive',
  'expand','win','breakout','high','dividend','milestone','approval','launch','innovation','jump',
  'above','better','best','top','leading','breakthrough']);
const NEG_EN = new Set(['fall','drop','decline','miss','loss','weak','cut','downgrade','bearish',
  'crash','plunge','sell','layoff','recall','lawsuit','fine','fraud','risk','warning','concern',
  'low','disappoint','below','short','debt','bankrupt','resign','probe','investigation','slump',
  'worse','worst','bottom','fail','negative','miss']);
const POS_JA = new Set(['ä¸Šæ˜‡','æ€¥é¨°','æœ€é«˜å€¤','å¢—ç›Š','å¢—å','å¥½èª¿','é»’å­—','è²·ã„','ä¸Šæ–¹ä¿®æ­£',
  'å›å¾©','å¥½æ¥­ç¸¾','æˆé•·','åˆ©ç›Š','é…å½“','æ–°é«˜å€¤','çªç ´','å¼·æ°—','æ‹¡å¤§','æ‰¿èª']);
const NEG_JA = new Set(['ä¸‹è½','æ€¥è½','æœ€å®‰å€¤','æ¸›ç›Š','æ¸›å','ä¸èª¿','èµ¤å­—','å£²ã‚Š','ä¸‹æ–¹ä¿®æ­£',
  'æå¤±','ãƒªã‚¹ãƒˆãƒ©','è§£é›‡','è¨´è¨Ÿ','ä¸æ­£','æ‡¸å¿µ','ãƒªã‚¹ã‚¯','è­¦å‘Š','ç ´ç¶»','è¾ä»»','å•é¡Œ']);

function sentiment(text, lang) {
  if (!text) return { label:'neutral', score:0 };
  const words = text.toLowerCase().match(/\w+/g) || [];
  let pos = words.filter(w => POS_EN.has(w)).length;
  let neg = words.filter(w => NEG_EN.has(w)).length;
  if (lang === 'ja') {
    POS_JA.forEach(k => { if (text.includes(k)) pos++; });
    NEG_JA.forEach(k => { if (text.includes(k)) neg++; });
  }
  const total = pos + neg;
  if (!total) return { label:'neutral', score:0 };
  const score = (pos - neg) / total;
  return { label: score > 0.1 ? 'positive' : score < -0.1 ? 'negative' : 'neutral', score };
}

function enrich(items, ticker) {
  const seen = new Set();
  return items
    .filter(i => { if (!i.url || seen.has(i.url)) return false; seen.add(i.url); return true; })
    .map(i => {
      const { label, score } = sentiment(`${i.title} ${i.summary}`, i.lang);
      return { ...i, ticker, sentiment: label, score: Math.round(score*1000)/1000 };
    })
    .sort((a,b) => (b.pubDate||0) - (a.pubDate||0));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN FETCH ORCHESTRATOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doFetch() {
  const tick = document.getElementById('tickerIn').value.trim().toUpperCase();
  if (!tick) { shakeSearch(); return; }
  curTick   = tick;
  articles  = [];
  filter    = 'all';
  langMode  = 'en';
  translationCache = {};
  document.getElementById('btnEN').classList.add('active');
  document.getElementById('btnJP').classList.remove('active');
  document.getElementById('langToggle').classList.remove('show');
  renderList();
  setBusy(true);
  setSignal('å–å¾—ä¸­', true);
  highlightChip(tick);

  const crawlers = [];
  if (cfg.sources.yahoo)       crawlers.push(['Yahoo Finance',  crawlYahoo(tick)]);
  if (cfg.sources.google_news) crawlers.push(['Google News',    crawlGoogleNews(tick)]);
  if (cfg.sources.stocktwits)  crawlers.push(['StockTwits',     crawlStockTwits(tick)]);
  if (cfg.sources.reddit)      crawlers.push(['Reddit',         crawlReddit(tick)]);

  let done = 0;
  const total = crawlers.length;

  const results = await Promise.allSettled(crawlers.map(async ([name, p]) => {
    try {
      const items = await p;
      articles.push(...items);
      articles = enrich(articles, tick);
      done++;
      setStatus(`${name} å®Œäº† (${done}/${total})`);
      renderList(); updateStats();
      return items.length;
    } catch(e) {
      done++;
      setStatus(`${name} å–å¾—å¤±æ•— (${done}/${total})`);
      return 0;
    }
  }));

  setBusy(false);
  const totalFound = articles.length;
  if (totalFound === 0) {
    setStatus('è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ â€” åˆ¥ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’è©¦ã—ã¦ãã ã•ã„');
    setSignal('å®Œäº†', false);
    showToast('è¨˜äº‹å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šã§ãƒ—ãƒ­ã‚­ã‚·ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„');
  } else {
    setStatus(`âœ… ${totalFound}ä»¶å–å¾—å®Œäº† â€” ${tick}`);
    setSignal(`${totalFound}ä»¶`, false);
    addToWatch(tick);
    document.getElementById('langToggle').classList.add('show');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TRANSLATION (JP/EN)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function setLang(mode) {
  langMode = mode;
  document.getElementById('btnEN').classList.toggle('active', mode === 'en');
  document.getElementById('btnJP').classList.toggle('active', mode === 'jp');
  if (mode === 'jp') {
    await translatePendingArticles();
  }
  renderList();
}

async function translatePendingArticles() {
  const toTranslate = articles.filter(a => {
    const isAlreadyJP = a.lang === 'ja';
    const cached = translationCache[a.url];
    return !isAlreadyJP && !cached;
  });
  if (!toTranslate.length) return;

  const badge = document.getElementById('transBadge');
  badge.classList.add('show');

  // MyMemoryç„¡æ–™API: 1ä»¶ãšã¤é€æ¬¡ç¿»è¨³ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
  for (const a of toTranslate) {
    try {
      const q = encodeURIComponent(a.title.slice(0, 500));
      const res = await fetch(`https://api.mymemory.translated.net/get?q=${q}&langpair=en|ja`);
      const data = await res.json();
      const translated = data?.responseData?.translatedText;
      if (translated && translated !== a.title) {
        translationCache[a.url] = translated;
      } else {
        translationCache[a.url] = a.title; // fallback
      }
      renderList();
      await sleep(120); // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
    } catch(e) {
      translationCache[a.url] = a.title; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãã®ã¾ã¾
    }
  }
  badge.classList.remove('show');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  const el = document.getElementById('list');
  let filtered = articles;
  if (filter === 'positive') filtered = articles.filter(a => a.sentiment==='positive');
  else if (filter === 'negative') filtered = articles.filter(a => a.sentiment==='negative');
  else if (filter === 'neutral')  filtered = articles.filter(a => a.sentiment==='neutral');
  else if (filter.startsWith('src:')) {
    const s = filter.slice(4);
    filtered = articles.filter(a => (a.source||'').includes(s));
  }

  if (!filtered.length) {
    el.innerHTML = `<div class="splash">
      <div class="splash-ico">${articles.length?'ğŸ”':'ğŸ“¡'}</div>
      <div class="splash-ttl">${articles.length?'è©²å½“ãªã—':'FinNews'}</div>
      <div class="splash-sub">${articles.length?'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„':'ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚’å…¥åŠ›ã—ã¦å–å¾—ã—ã¦ãã ã•ã„'}</div>
    </div>`;
    return;
  }

  el.innerHTML = filtered.map((a, i) => {
    const barCls = a.sentiment==='positive'?'bp':a.sentiment==='negative'?'bn':'bu';
    const srcCls = getSrcCls(a.source);
    const score  = a.score != null
      ? `<span class="card-score ${a.score>=0?'sp':'sn'}">${a.score>0?'+':''}${a.score.toFixed(2)}</span>`
      : '';
    const date = fmtDate(a.pubDate);
    // Use translated title if in JP mode and translation is available
    let displayTitle = a.title;
    if (langMode === 'jp') {
      if (a.lang === 'ja') {
        displayTitle = a.title; // already Japanese
      } else {
        displayTitle = translationCache[a.url] || a.title; // use cache or fallback
      }
    }
    return `<div class="card" onclick="openArticle('${esc(a.url)}')" style="animation-delay:${Math.min(i*.025,.5)}s;cursor:pointer">
      <div class="bar ${barCls}"></div>
      <div class="card-body">
        <div class="card-title">${esc(displayTitle)}</div>
        <div class="card-meta">
          <span class="src ${srcCls}">${esc(a.source)}</span>
          <span class="card-date">${date}</span>
          ${score}
        </div>
      </div>
      <div class="chevron">â€º</div>
    </div>`;
  }).join('');
}

function updateStats() {
  const pos = articles.filter(a=>a.sentiment==='positive').length;
  const neg = articles.filter(a=>a.sentiment==='negative').length;
  const neu = articles.filter(a=>a.sentiment==='neutral').length;
  document.getElementById('sAll').textContent = articles.length;
  document.getElementById('sPos').textContent = pos;
  document.getElementById('sNeg').textContent = neg;
  document.getElementById('sNeu').textContent = neu;
  const show = articles.length > 0;
  document.getElementById('stats').classList.toggle('show', show);
  document.getElementById('ftabs').classList.toggle('show', show);
  if (!show) document.getElementById('langToggle').classList.remove('show');
}

function flt(f) {
  filter = f;
  document.querySelectorAll('.ftab').forEach(b => b.className = 'ftab');
  const map = { all:'ta', positive:'tp', negative:'tn', neutral:'tu' };
  const tabMap = {
    all:0, positive:1, negative:2, neutral:3, 'src:yahoo':4, 'src:google_news':5, 'src:reddit':6, 'src:stocktwits':7
  };
  const tabs = document.querySelectorAll('.ftab');
  const idx  = tabMap[f];
  if (idx !== undefined && tabs[idx]) tabs[idx].className = 'ftab ' + (map[f] || 'ts');
  renderList();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WATCHLIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addToWatch(t) {
  if (!watchlist.includes(t)) {
    watchlist.unshift(t);
    if (watchlist.length > 30) watchlist = watchlist.slice(0,30);
    localStorage.setItem('fn_watch', JSON.stringify(watchlist));
  }
}

function renderWatch() {
  const el = document.getElementById('watchList');
  if (!watchlist.length) {
    el.innerHTML = '<div style="padding:60px 20px;text-align:center;color:var(--text3);font-size:14px">ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã¯ç©ºã§ã™<br><span style="font-size:11px">å–å¾—å¾Œã«è‡ªå‹•è¿½åŠ ã•ã‚Œã¾ã™</span></div>';
    return;
  }
  el.innerHTML = watchlist.map(t => `
    <div class="witem" onclick="loadWatch('${esc(t)}')">
      <span class="wtick">${esc(t)}</span>
      <span class="wdel" onclick="event.stopPropagation();removeWatch('${esc(t)}')">âœ•</span>
    </div>`).join('');
}

function loadWatch(t) {
  closePanel();
  document.getElementById('tickerIn').value = t;
  doFetch();
}

function removeWatch(t) {
  watchlist = watchlist.filter(x => x !== t);
  localStorage.setItem('fn_watch', JSON.stringify(watchlist));
  renderWatch();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SETTINGS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSrcToggles() {
  const el = document.getElementById('srcToggles');
  el.innerHTML = SOURCES_DEF.map(s => `
    <label style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer">
      <span style="font-size:18px">${s.icon}</span>
      <span style="flex:1">
        <span style="font-size:13px;color:var(--text)">${s.label}</span>
        ${s.note ? `<span style="display:block;font-size:10px;color:var(--text3)">${s.note}</span>` : ''}
      </span>
      <input type="checkbox" ${cfg.sources[s.id]?'checked':''} onchange="toggleSrc('${s.id}',this.checked)"
        style="width:20px;height:20px;accent-color:var(--accent);cursor:pointer">
    </label>`).join('');

  document.getElementById('proxySelect').value   = cfg.proxy   || 'allorigins';
  document.getElementById('browserSelect').value = cfg.browser || 'safari';
}

function toggleSrc(id, val) {
  cfg.sources[id] = val;
  saveCfg();
}

function saveCfg() {
  cfg.proxy    = document.getElementById('proxySelect').value;
  cfg.browser  = document.getElementById('browserSelect').value;
  localStorage.setItem('fn_cfg', JSON.stringify(cfg));
}

// ãƒ–ãƒ©ã‚¦ã‚¶åˆ¥URLã‚¹ã‚­ãƒ¼ãƒ å¤‰æ›
function toBrowserUrl(url) {
  const b = cfg.browser || 'safari';
  if (b === 'safari')  return url; // ãã®ã¾ã¾
  if (b === 'chrome') {
    // googlechrome:// ã¾ãŸã¯ googlechromes://
    return url.replace(/^http:\/\//, 'googlechrome://')
               .replace(/^https:\/\//, 'googlechromes://');
  }
  if (b === 'brave') {
    return url.replace(/^http:\/\//, 'brave://')
               .replace(/^https:\/\//, 'brave://');
  }
  if (b === 'firefox') {
    return `firefox://open-url?url=${encodeURIComponent(url)}`;
  }
  if (b === 'edge') {
    return `microsoft-edge-https://${url.replace(/^https?:\/\//, '')}`;
  }
  return url;
}

function openArticle(url) {
  const dest = toBrowserUrl(url);
  window.location.href = dest;
}

function clearData() {
  if (confirm('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    localStorage.removeItem('fn_watch');
    localStorage.removeItem('fn_cfg');
    articles = []; watchlist = [];
    renderList(); renderWatch(); updateStats();
    showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TABS / PANELS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tab) {
  ['news','watch','settings'].forEach(t =>
    document.getElementById('ni-'+t).classList.toggle('on', t===tab));
  if (tab==='watch')    { renderWatch();    document.getElementById('watchPanel').classList.add('open'); }
  if (tab==='settings') { renderSrcToggles(); document.getElementById('settingsPanel').classList.add('open'); }
  if (tab==='news')     closePanel();
}

function closePanel() {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('open'));
  ['news','watch','settings'].forEach((t,i) =>
    document.getElementById('ni-'+t).classList.toggle('on', i===0));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTick(t) {
  document.getElementById('tickerIn').value = t;
  doFetch();
}

function highlightChip(t) {
  document.querySelectorAll('.chip').forEach(c => c.classList.toggle('on', c.textContent===t));
}

function setBusy(on) {
  const p = document.getElementById('prog');
  p.className = 'prog-bar' + (on ? ' spin' : '');
  document.getElementById('goBtn').className = 'go-btn' + (on ? ' busy' : '');
  document.getElementById('goBtn').textContent = on ? 'å–å¾—ä¸­' : 'å–å¾—';
}

function setStatus(msg) { document.getElementById('status').textContent = msg; }

function setSignal(txt, active) {
  document.getElementById('sigTxt').textContent = txt;
  document.getElementById('sigDot').classList.toggle('live', active);
}

function shakeSearch() {
  const el = document.querySelector('.search-box');
  el.style.borderColor='var(--red)';
  el.style.boxShadow='0 0 0 3px rgba(240,85,106,.2)';
  setTimeout(() => { el.style.borderColor=''; el.style.boxShadow=''; }, 700);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function getSrcCls(s) {
  if (!s) return '';
  if (s==='bloomberg') return 'src-bloomberg';
  if (s==='wsj')       return 'src-wsj';
  if (s==='nikkei')    return 'src-nikkei';
  if (s==='reuters')   return 'src-reuters';
  if (s==='reddit')    return 'src-reddit';
  if (s==='stocktwits') return 'src-stocktwits';
  if (s==='yahoo')     return 'src-yahoo';
  return '';
}

function fmtDate(d) {
  if (!d || isNaN(d)) return '';
  const diff = (Date.now() - d) / 1000;
  if (diff < 3600)    return `${Math.floor(diff/60)}åˆ†å‰`;
  if (diff < 86400)   return `${Math.floor(diff/3600)}æ™‚é–“å‰`;
  if (diff < 2592000) return `${Math.floor(diff/86400)}æ—¥å‰`;
  return d.toLocaleDateString('ja-JP', {month:'short', day:'numeric'});
}

function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// iOS INSTALL HINT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showInstallHint() {
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSA  = window.navigator.standalone;
  if (isIOS && !isSA && !localStorage.getItem('fn_installed')) {
    document.getElementById('installBanner').classList.add('show');
  }
}
function dismissInstall() {
  localStorage.setItem('fn_installed','1');
  document.getElementById('installBanner').classList.remove('show');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('tickerIn').addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.target.blur(); doFetch(); }
  });
  showInstallHint();
});
</script>
</body>
</html>
